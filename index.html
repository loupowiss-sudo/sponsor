<!DOCTYPE html>
<html lang="fr">
<head>


  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sponsoring Manager PRO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    .fade-in { animation: fadeIn 0.5s ease forwards; opacity: 0; }
    @keyframes fadeIn { to { opacity: 1; } }
    .hover-scale:hover { transform: scale(1.03); transition: transform 0.2s; }
    .active-tab {
      background: linear-gradient(135deg, #2563eb 0%, #4f46e5 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    .card-hover { transition: all 0.3s ease; border: 1px solid transparent; }
    .card-hover:hover { border-color: #3b82f6; box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.2); }
    .modal-show { animation: modalFadeIn 0.3s ease; }
    @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .profit-badge { background-color: #dcfce7; color: #166534; }
    .loss-badge { background-color: #fee2e2; color: #991b1b; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen p-4 md:p-6 font-sans text-slate-800">
  <div class="max-w-7xl mx-auto space-y-6">

    <!-- HEADER -->
    <header class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 border fade-in">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <div class="w-12 h-12 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center">
              <i class="fas fa-handshake text-white text-2xl"></i>
            </div>
            <div>
              <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                Sponsoring Manager PRO
              </h1>
              <p class="text-sm md:text-lg text-gray-600 mt-1">
                Gestion clients ‚Ä¢ Offres ‚Ä¢ Transactions ‚Ä¢ Paiements ‚Ä¢ Achats USD
              </p>
            </div>
          </div>
        </div>
        <div class="flex gap-2 md:gap-3 flex-wrap justify-center">
          <button onclick="exportPDF()" class="px-4 md:px-6 py-2 md:py-3 bg-gradient-to-r from-red-500 to-red-600 text-white font-bold rounded-xl hover:shadow-lg transition-all shadow flex items-center gap-2">
            <i class="fas fa-file-pdf"></i>
            <span class="hidden sm:inline">Export PDF</span>
          </button>
          <button onclick="backupData()" class="px-4 md:px-6 py-2 md:py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold rounded-xl hover:shadow-lg transition-all shadow flex items-center gap-2">
            <i class="fas fa-download"></i>
            <span class="hidden sm:inline">Backup JSON</span>
          </button>
          <button onclick="importData()" class="px-4 md:px-6 py-2 md:py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold rounded-xl hover:shadow-lg transition-all shadow flex items-center gap-2">
            <i class="fas fa-upload"></i>
            <span class="hidden sm:inline">Import JSON</span>
          </button>
          <button onclick="showStats()" class="px-4 md:px-6 py-2 md:py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold rounded-xl hover:shadow-lg transition-all shadow flex items-center gap-2">
            <i class="fas fa-chart-bar"></i>
            <span class="hidden sm:inline">Statistiques</span>
          </button>
        </div>
      </div>
    </header>

    <!-- NAV TABS -->
    <nav class="bg-white rounded-3xl shadow-xl p-4 md:p-6 border mb-6 fade-in" style="animation-delay: 0.1s;">
      <div class="flex flex-wrap -mx-1">
        <button onclick="showTab('dashboard')" id="tab-dashboard"
                class="tab-btn m-1 px-4 md:px-6 py-3 font-bold bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-2xl shadow hover:shadow-lg transition-all flex items-center gap-2">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
        </button>
        <button onclick="showTab('clients')" id="tab-clients"
                class="tab-btn m-1 px-4 md:px-6 py-3 font-semibold text-gray-700 bg-gray-100 hover:bg-blue-50 rounded-xl transition-all hover-scale flex items-center gap-2">
          <i class="fas fa-users"></i>
          <span>Clients</span>
        </button>
        <button onclick="showTab('transactions')" id="tab-transactions"
                class="tab-btn m-1 px-4 md:px-6 py-3 font-semibold text-gray-700 bg-gray-100 hover:bg-green-50 rounded-xl transition-all hover-scale flex items-center gap-2">
          <i class="fas fa-exchange-alt"></i>
          <span>Transactions</span>
        </button>
        <button onclick="showTab('offers')" id="tab-offers"
                class="tab-btn m-1 px-4 md:px-6 py-3 font-semibold text-gray-700 bg-gray-100 hover:bg-purple-50 rounded-xl transition-all hover-scale flex items-center gap-2">
          <i class="fas fa-gift"></i>
          <span>Offres</span>
        </button>
        <button onclick="showTab('paiements')" id="tab-paiements"
                class="tab-btn m-1 px-4 md:px-6 py-3 font-semibold text-gray-700 bg-gray-100 hover:bg-orange-50 rounded-xl transition-all hover-scale flex items-center gap-2">
          <i class="fas fa-credit-card"></i>
          <span>Paiements</span>
        </button>
        <button onclick="showTab('achats')" id="tab-achats"
                class="tab-btn m-1 px-4 md:px-6 py-3 font-semibold text-gray-700 bg-gray-100 hover:bg-teal-50 rounded-xl transition-all hover-scale flex items-center gap-2">
          <i class="fas fa-dollar-sign"></i>
          <span>Achats USD</span>
        </button>
      </div>
    </nav>

    <!-- CONTENT AREA -->
    <div class="space-y-6">
      <!-- DASHBOARD TAB -->
      <section id="dashboard" class="tab-content fade-in" style="animation-delay: 0.2s;">
        <!-- STATS CARDS -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
          <div class="bg-gradient-to-br from-emerald-500 to-green-600 text-white p-5 md:p-6 rounded-2xl shadow-xl hover-scale card-hover">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-sm opacity-90 mb-2">Profit Aujourd'hui</p>
                <p id="todayProfit" class="text-2xl md:text-3xl font-black">0 DZD</p>
              </div>
              <i class="fas fa-sun text-2xl opacity-80"></i>
            </div>
            <div class="mt-4 text-sm opacity-90">
              <i class="fas fa-arrow-up mr-1"></i>
              <span id="todayChange">0%</span> vs hier
            </div>
          </div>
          <div class="bg-gradient-to-br from-blue-500 to-cyan-600 text-white p-5 md:p-6 rounded-2xl shadow-xl hover-scale card-hover">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-sm opacity-90 mb-2">Profit Semaine</p>
                <p id="weekProfit" class="text-2xl md:text-3xl font-black">0 DZD</p>
              </div>
              <i class="fas fa-calendar-week text-2xl opacity-80"></i>
            </div>
            <div class="mt-4 text-sm opacity-90">
              <i class="fas fa-chart-line mr-1"></i>
              <span id="weekTransactions">0 transactions</span>
            </div>
          </div>
          <div class="bg-gradient-to-br from-purple-500 to-pink-600 text-white p-5 md:p-6 rounded-2xl shadow-xl hover-scale card-hover">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-sm opacity-90 mb-2">Profit Total</p>
                <p id="totalProfit" class="text-2xl md:text-3xl font-black">0 DZD</p>
              </div>
              <i class="fas fa-chart-pie text-2xl opacity-80"></i>
            </div>
            <div class="mt-4 text-sm opacity-90">
              <i class="fas fa-wallet mr-1"></i>
              <span id="totalTransactions">0 transactions</span>
            </div>
          </div>
          <div class="bg-gradient-to-br from-orange-500 to-red-600 text-white p-5 md:p-6 rounded-2xl shadow-xl hover-scale card-hover">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-sm opacity-90 mb-2">Total Clients</p>
                <p id="totalClients" class="text-2xl md:text-3xl font-black">0</p>
              </div>
              <i class="fas fa-user-friends text-2xl opacity-80"></i>
            </div>
            <div class="mt-4 text-sm opacity-90">
              <i class="fas fa-user-plus mr-1"></i>
              <span id="newClients">0 nouveaux ce mois</span>
            </div>
          </div>
        </div>

        <!-- CALCULATOR + RESULTS -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mb-8">
          <!-- CALCULATOR -->
          <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border fade-in card-hover">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-calculator text-blue-600"></i>
                Nouvelle Transaction
              </h2>
              <button onclick="resetCalculator()" class="text-sm text-gray-500 hover:text-gray-700 flex items-center gap-1">
                <i class="fas fa-redo"></i>
                R√©initialiser
              </button>
            </div>
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-shopping-cart text-green-600"></i>
                    Taux Achat $ (DZD/USD)
                  </label>
                  <div class="relative">
                    <input id="buyRate" type="number" value="255" step="0.01"
                           class="w-full p-4 border rounded-xl text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                           oninput="calculatePreview()">
                    <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500">DZD</span>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-gift text-purple-600"></i>
                    Offre
                  </label>
                  <select id="offerSelect"
                          class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                          onchange="selectOfferInTransaction()">
                    <option value="">S√©lectionner une offre...</option>
                  </select>
                </div>
              </div>
              <div id="standardFields" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                <div>
                  <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-dollar-sign text-teal-600"></i>
                    Montant $ (Standard)
                  </label>
                  <input id="standardDollarAmount" type="number" step="0.01"
                         class="w-full p-4 border rounded-xl text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                         oninput="calculatePreview()">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-tag text-indigo-600"></i>
                    Prix Vente Standard (DZD)
                  </label>
                  <input id="standardPriceDzd" type="number" step="0.01"
                         class="w-full p-4 border rounded-xl text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                         oninput="calculatePreview()">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-clock text-gray-600"></i>
                    Dur√©e
                  </label>
                  <input id="standardDuration" type="text"
                         class="w-full p-4 border rounded-xl text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                         placeholder="Ex: 30 jours, 3 mois">
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-user text-blue-600"></i>
                    Client
                  </label>
                  <div class="relative">
                    <input id="clientSearch" type="text" placeholder="Chercher un client..." 
                           class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                           oninput="filterClients()">
                    <input id="clientSelect" type="hidden" value="">
                    <div id="clientDropdown" class="absolute z-50 w-full mt-1 bg-white border border-blue-200 rounded-xl shadow-xl hidden max-h-64 overflow-y-auto">
                      <!-- Rempli dynamiquement par JavaScript -->
                    </div>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-600"></i>
                    D√©tails Offre
                  </label>
                  <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                    <p id="offerDetails" class="text-sm text-gray-600">S√©lectionnez une offre</p>
                  </div>
                </div>
              </div>
              <div class="flex items-center gap-3"></div>
                <input id="transactionPaid" type="checkbox" class="w-5 h-5 accent-blue-600" checked>
                <label for="transactionPaid" class="text-sm font-semibold text-gray-700">Pay√©e</label>
              </div>

              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-5 rounded-2xl border border-blue-100 space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-gray-700 font-medium">Co√ªt (Achat):</span>
                  <span id="previewCost" class="font-bold text-red-600 text-lg">0 DZD</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-700 font-medium">Vente:</span>
                  <span id="previewRevenue" class="font-bold text-green-600 text-lg">0 DZD</span>
                </div>
                <div class="border-t border-blue-200 pt-3 flex justify-between items-center">
                  <span class="text-gray-800 font-bold text-lg">Marge:</span>
                  <span id="previewProfit" class="font-bold text-blue-700 text-xl">0 DZD</span>
                </div>
                <div class="pt-2">
                  <div id="profitPercentage" class="text-center text-sm font-medium text-gray-600">
                    Marge: 0.00%
                  </div>
                </div>
              </div>

              <button onclick="addTransaction()"
                      class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold rounded-xl shadow-lg hover:shadow-2xl hover-scale transition-all text-lg flex items-center justify-center gap-3">
                <i class="fas fa-check-circle"></i>
                Valider la Transaction
              </button>
            </div>
          </div>

          <!-- RECENT ACTIVITY -->
          <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border fade-in card-hover">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-history text-purple-600"></i>
                Activit√© R√©cente
              </h2>
              <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full" id="activityCount">0 transactions</span>
            </div>
            <div id="recentTransactions" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
              <div class="text-center py-10">
                <i class="fas fa-exchange-alt text-gray-300 text-4xl mb-3"></i>
                <p class="text-gray-400 italic">Aucune transaction r√©cente</p>
                <p class="text-sm text-gray-500 mt-2">Les transactions appara√Ætront ici</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CLIENTS TAB -->
      <section id="clients" class="tab-content hidden fade-in">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border card-hover">
          <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
            <div>
              <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-users text-blue-600"></i>
                Liste des Clients
              </h2>
              <p class="text-gray-600 text-sm mt-1">G√©rez vos clients et suivez leur activit√©</p>
            </div>
            <div class="flex gap-2">
              <button onclick="openModal('clientModal')"
                      class="px-4 md:px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center gap-2">
                <i class="fas fa-plus"></i>
                Nouveau Client
              </button>
              <button onclick="exportClientsCSV()"
                      class="px-4 md:px-6 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center gap-2">
                <i class="fas fa-file-export"></i>
                Exporter
              </button>
            </div>
          </div>
          <div class="overflow-x-auto rounded-xl border">
            <table class="w-full text-left">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-blue-50">
                  <th class="p-4 rounded-l-lg font-semibold text-gray-700">Nom</th>
                  <th class="p-4 font-semibold text-gray-700">Contact</th>
                  <th class="p-4 font-semibold text-gray-700">Total D√©pens√©</th>
                  <th class="p-4 font-semibold text-gray-700">Impay√©</th>
                  <th class="p-4 font-semibold text-gray-700">Transactions</th>
                  <th class="p-4 rounded-r-lg font-semibold text-gray-700">Actions</th>
                </tr>
              </thead>
              <tbody id="clientsTableBody" class="divide-y divide-gray-100">
                <!-- Rempli par JavaScript -->
              </tbody>
            </table>
          </div>
          <div class="mt-4 text-sm text-gray-500 flex justify-between items-center">
            <span id="clientsSummary">0 clients</span>
            <span id="clientsTotalSpent">Total d√©pens√©: 0 DZD</span>
          </div>
        </div>
      </section>

      <!-- TRANSACTIONS TAB -->
      <section id="transactions" class="tab-content hidden fade-in">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border card-hover">
          <div class="mb-6">
            <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2 mb-4">
              <i class="fas fa-exchange-alt text-green-600"></i>
              Toutes les Transactions
            </h2>
            <div class="flex flex-col md:flex-row gap-4">
              <input id="transactionSearch" type="text" placeholder="Rechercher..." 
                     class="flex-1 p-3 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
              <select id="transactionFilter"
                      class="p-3 border rounded-xl focus:ring-2 focus:ring-green-500 outline-none">
                <option value="all">Toutes les p√©riodes</option>
                <option value="today">Aujourd'hui</option>
                <option value="week">Cette semaine</option>
                <option value="month">Ce mois</option>
              </select>
            </div>
          </div>
          <div class="overflow-x-auto rounded-xl border">
            <table class="w-full text-left text-sm">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-green-50">
                  <th class="p-4 rounded-l-lg font-semibold text-gray-700">Date</th>
                  <th class="p-4 font-semibold text-gray-700">Client</th>
                  <th class="p-4 font-semibold text-gray-700">Offre</th>
                  <th class="p-4 font-semibold text-gray-700">Montant</th>
                  <th class="p-4 font-semibold text-gray-700">Prix Vente</th>
                  <th class="p-4 font-semibold text-gray-700">Total</th>
                  <th class="p-4 font-semibold text-gray-700">Profit</th>
                  <th class="p-4 font-semibold text-gray-700">Dur√©e</th>
                  <th class="p-4 rounded-r-lg font-semibold text-gray-700">Actions</th>
                </tr>
              </thead>
              <tbody id="transactionsTableBody" class="divide-y divide-gray-100">
                <!-- Rempli par JavaScript -->
              </tbody>
            </table>
          </div>
          <div class="mt-4 text-sm text-gray-500 flex justify-between items-center">
            <span id="transactionsSummary">0 transactions</span>
            <span id="transactionsTotalProfit">Profit total: 0 DZD</span>
          </div>
        </div>
      </section>

      <!-- OFFERS TAB -->
      <section id="offers" class="tab-content hidden fade-in">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border card-hover">
          <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
            <div>
              <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-gift text-purple-600"></i>
                Mes Offres
              </h2>
              <p class="text-gray-600 text-sm mt-1">G√©rez vos offres commerciales</p>
            </div>
            <button onclick="openModal('offerModal')"
                    class="px-4 md:px-6 py-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center gap-2">
              <i class="fas fa-plus"></i>
              Nouvelle Offre
            </button>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="offersGrid">
            <!-- Rempli par JavaScript -->
          </div>
        </div>
      </section>

      <!-- PAIEMENTS TAB -->
      <section id="paiements" class="tab-content hidden fade-in">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border card-hover">
          <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
            <div>
              <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-credit-card text-orange-600"></i>
                Suivi des Paiements
              </h2>
              <p class="text-gray-600 text-sm mt-1">Suivez les paiements de vos clients</p>
            </div>
            <button onclick="openModal('paymentModal')"
                    class="px-4 md:px-6 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center gap-2">
              <i class="fas fa-plus"></i>
              Enregistrer Paiement
            </button>
          </div>
          <div class="overflow-x-auto rounded-xl border">
            <table class="w-full text-left text-sm">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-orange-50">
                  <th class="p-4 rounded-l-lg font-semibold text-gray-700">Date</th>
                  <th class="p-4 font-semibold text-gray-700">Client</th>
                  <th class="p-4 font-semibold text-gray-700">Montant</th>
                  <th class="p-4 font-semibold text-gray-700">M√©thode</th>
                  <th class="p-4 font-semibold text-gray-700">Statut</th>
                  <th class="p-4 rounded-r-lg font-semibold text-gray-700">Note</th>
                </tr>
              </thead>
              <tbody id="paymentsTableBody" class="divide-y divide-gray-100">
                <!-- Rempli par JavaScript -->
              </tbody>
            </table>
          </div>
          <div class="mt-4 text-sm text-gray-500 flex justify-between items-center">
            <span id="paymentsSummary">0 paiements</span>
            <span id="paymentsTotal" class="font-bold text-green-600">Total: 0 DZD</span>
          </div>
        </div>
      </section>

      <!-- ACHATS USD TAB -->
      <section id="achats" class="tab-content hidden fade-in">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border card-hover">
          <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 gap-4">
            <div>
              <h2 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                <i class="fas fa-dollar-sign text-teal-600"></i>
                Achats de Stock USD
              </h2>
              <p class="text-gray-600 text-sm mt-1">G√©rez vos achats de dollars</p>
            </div>
            <button onclick="openModal('usdPurchaseModal')"
                    class="px-4 md:px-6 py-2 bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center gap-2">
              <i class="fas fa-plus"></i>
              Nouvel Achat USD
            </button>
          </div>
          <div class="overflow-x-auto rounded-xl border">
            <table class="w-full text-left text-sm">
              <thead>
                <tr class="bg-gradient-to-r from-gray-50 to-teal-50">
                  <th class="p-4 rounded-l-lg font-semibold text-gray-700">Date</th>
                  <th class="p-4 font-semibold text-gray-700">Montant $</th>
                  <th class="p-4 font-semibold text-gray-700">Taux Achat</th>
                  <th class="p-4 font-semibold text-gray-700">Total DZD</th>
                  <th class="p-4 font-semibold text-gray-700">Source</th>
                  <th class="p-4 rounded-r-lg font-semibold text-gray-700">Actions</th>
                </tr>
              </thead>
              <tbody id="usdPurchasesTableBody" class="divide-y divide-gray-100">
                <!-- Rempli par JavaScript -->
              </tbody>
            </table>
          </div>
          <div class="mt-4 text-sm text-gray-500 flex justify-between items-center">
            <span id="usdPurchasesSummary">0 achats</span>
            <span id="usdPurchasesTotal" class="font-bold text-blue-600">Total USD: 0</span>
          </div>
        </div>
      </section>
    </div>

    <!-- MODALS -->
    <div id="clientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 modal-backdrop">
      <div class="bg-white p-6 md:p-8 rounded-2xl w-full max-w-md modal-show">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <i class="fas fa-user-plus text-blue-600"></i>
            Ajouter un Client
          </h3>
          <button onclick="closeModal('clientModal')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <input id="newClientName" type="text" placeholder="Nom complet du client" 
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
        <input id="newClientContact" type="text" placeholder="Contact (T√©l√©phone, Facebook, etc.)" 
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
        <textarea id="newClientNotes" placeholder="Notes suppl√©mentaires (optionnel)" 
                  class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" rows="3"></textarea>
        <div class="flex justify-end gap-3">
          <button onclick="closeModal('clientModal')" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
            Annuler
          </button>
          <button onclick="addClient()" class="px-5 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:shadow-lg transition-all font-medium">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <div id="offerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 modal-backdrop">
      <div class="bg-white p-6 md:p-8 rounded-2xl w-full max-w-md modal-show">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <i class="fas fa-gift text-purple-600"></i>
            Ajouter une Offre
          </h3>
          <button onclick="closeModal('offerModal')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <input id="newOfferName" type="text" placeholder="Nom de l'offre (ex: Pack Gold)" 
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all">
        <textarea id="newOfferDesc" placeholder="Description d√©taill√©e" 
                  class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all" rows="3"></textarea>
        <input id="newOfferPrice" type="number" placeholder="Prix Vente (DZD)" step="0.01"
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all">
        <input id="newOfferCostPerUnit" type="number" step="0.01" placeholder="Montant √† d√©penser ($)" 
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all">
        <input id="newOfferDuration" type="text" placeholder="Dur√©e de l'offre (ex: 30 jours, 3 mois)" 
               class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition-all">
        <div class="flex justify-end gap-3">
          <button onclick="closeModal('offerModal')" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
            Annuler
          </button>
          <button onclick="addOffer()" class="px-5 py-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:shadow-lg transition-all font-medium">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <div id="paymentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 modal-backdrop">
      <div class="bg-white p-6 md:p-8 rounded-2xl w-full max-w-md modal-show">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <i class="fas fa-credit-card text-orange-600"></i>
            Enregistrer Paiement
          </h3>
          <button onclick="closeModal('paymentModal')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <select id="paymentClientSelect" class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all">
          <option value="">Choisir un client...</option>
        </select>
        <input id="paymentAmount" type="number" placeholder="Montant (DZD)" 
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all">
        <select id="paymentMethod" class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all">
          <option value="Cash">Cash</option>
          <option value="CCP">CCP</option>
          <option value="BaridiMob">BaridiMob</option>
          <option value="Paysera">Paysera</option>
          <option value="Virement">Virement bancaire</option>
          <option value="Carte">Carte bancaire</option>
        </select>
        <select id="paymentStatus" class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all">
          <option value="completed">Compl√©t√©</option>
          <option value="pending">En attente</option>
          <option value="partial">Partiel</option>
        </select>
        <input id="paymentNote" type="text" placeholder="Note (optionnel)" 
               class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all">
        <div class="flex justify-end gap-3">
          <button onclick="closeModal('paymentModal')" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
            Annuler
          </button>
          <button onclick="addPayment()" class="px-5 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all font-medium">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <div id="usdPurchaseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 modal-backdrop">
      <div class="bg-white p-6 md:p-8 rounded-2xl w-full max-w-md modal-show">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold flex items-center gap-2">
            <i class="fas fa-dollar-sign text-teal-600"></i>
            Achat Stock USD
          </h3>
          <button onclick="closeModal('usdPurchaseModal')" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        <input id="usdAmount" type="number" step="0.01" placeholder="Montant USD ($)" 
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all">
        <input id="usdRate" type="number" step="0.01" placeholder="Taux d'achat (DZD)" value="255"
               class="w-full p-4 border rounded-xl mb-3 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all">
        <input id="usdSource" type="text" placeholder="Source (ex: Binance P2P, Bank, etc.)" 
               class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all">
        <div class="flex justify-end gap-3">
          <button onclick="closeModal('usdPurchaseModal')" class="px-5 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
            Annuler
          </button>
          <button onclick="addUsdPurchase()" class="px-5 py-2 bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-lg hover:shadow-lg transition-all font-medium">
            Enregistrer
          </button>
        </div>
      </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="handleFileLoad(this)">

    <!-- NOTIFICATION TOAST -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-xl shadow-2xl hidden z-50 max-w-sm transition-all duration-300">
      <div class="flex items-center gap-3">
        <i id="toastIcon" class="fas fa-check-circle text-green-400 text-xl"></i>
        <div>
          <p id="toastTitle" class="font-bold">Succ√®s</p>
          <p id="toastMessage" class="text-sm text-gray-300">Op√©ration effectu√©e avec succ√®s</p>
        </div>
      </div>
    </div>

  </div>

<script>
let appState = {
  clients: [],
  transactions: [],
  offers: [],
  payments: [],
  usdPurchases: [],
  currentTab: 'dashboard',
settings: {
  storageMode: 'cloud',
  cloudProvider: 'firebase',
  autoSaveEnabled: true,

  firebaseConfig: {
    apiKey: "AIzaSyC-1uQnZRLzqUoTMQ_oaXNZh-QQROfOEqw",
    authDomain: "sponsorhichem.firebaseapp.com",
    projectId: "sponsorhichem",
    storageBucket: "sponsorhichem.firebasestorage.app",
    messagingSenderId: "499965988228",
    appId: "1:499965988228:web:ecdbd5b005c23b6d5c61d1"
  }
}
};

let autoSaveTimer = null;

document.addEventListener('DOMContentLoaded', async function() {
  console.log('üöÄ Sponsoring Manager PRO - Initialisation');
  if (appState.settings.storageMode === 'cloud') {
  await loadFromCloud();
} else {
  await loadFromLocalStorage();
}

  showTab('dashboard');
  updateDashboard();
  populatePaymentClientSelect();
  populateOfferSelect();
  renderTables();
  setupEventListeners();
  setupClientSearchListeners();
  showToast('Bienvenue dans Sponsoring Manager PRO!', 'success');
});

function setupClientSearchListeners() {
  const clientSearch = document.getElementById('clientSearch');
  const dropdown = document.getElementById('clientDropdown');
  
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.relative') && !e.target.closest('#clientDropdown')) {
      dropdown.classList.add('hidden');
    }
  });
  
  clientSearch.addEventListener('focus', function() {
    if (this.value.trim()) {
      filterClients();
    }
  });
}

function showTab(tabId) {
  console.log('üìå Changement d\'onglet vers:', tabId);
  appState.currentTab = tabId;
  document.querySelectorAll('.tab-content').forEach(tab => { tab.classList.add('hidden'); });
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active-tab');
    btn.classList.remove('bg-blue-600', 'text-white');
    btn.classList.add('text-gray-700', 'bg-gray-100');
  });
  const tabContent = document.getElementById(tabId);
  if (tabContent) {
    tabContent.classList.remove('hidden');
    tabContent.style.opacity = '0';
    tabContent.style.animation = 'fadeIn 0.5s ease forwards';
  }
  const activeBtn = document.getElementById(`tab-${tabId}`);
  if (activeBtn) {
    activeBtn.classList.remove('text-gray-700', 'bg-gray-100');
    activeBtn.classList.add('active-tab');
  }
  if (tabId === 'dashboard') { updateDashboard(); } 
  else if (tabId === 'clients') { updateClientsSummary(); } 
  else if (tabId === 'transactions') { updateTransactionsSummary(); }
}

function setupEventListeners() {
  const searchInput = document.getElementById('transactionSearch');
  const filterSelect = document.getElementById('transactionFilter');
  if (searchInput) { searchInput.addEventListener('input', filterTransactions); }
  if (filterSelect) { filterSelect.addEventListener('change', filterTransactions); }
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeAllModals(); }
  });
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-backdrop')) { closeAllModals(); }
  });
}

function selectOfferInTransaction() {
  const offerId = document.getElementById('offerSelect').value;
  const buyRate = parseFloat(document.getElementById('buyRate').value) || 0;
  const standardFields = document.getElementById('standardFields');
  const standardDollarInput = document.getElementById('standardDollarAmount');
  const standardPriceInput = document.getElementById('standardPriceDzd');
  
  if (!offerId) {
    if (standardFields) standardFields.classList.add('hidden');
    document.getElementById('offerDetails').textContent = 'S√©lectionnez une offre';
    document.getElementById('previewCost').textContent = '0 DZD';
    document.getElementById('previewRevenue').textContent = '0 DZD';
    document.getElementById('previewProfit').textContent = '0 DZD';
    document.getElementById('profitPercentage').textContent = 'Marge: 0.00%';
    return;
  }
  if (offerId === 'standard') {
    if (standardFields) standardFields.classList.remove('hidden');
    const dollarAmount = parseFloat(standardDollarInput && standardDollarInput.value) || 0;
    const price = parseFloat(standardPriceInput && standardPriceInput.value) || 0;
    const cost = dollarAmount * buyRate;
    const profit = price - cost;
    const profitPercentage = cost > 0 ? ((profit / cost) * 100).toFixed(2) : 0;
    let marginColor = 'text-green-600';
    if (profitPercentage < 10) marginColor = 'text-red-600';
    else if (profitPercentage < 20) marginColor = 'text-yellow-600';
    document.getElementById('offerDetails').innerHTML = `
    <div class="space-y-2">
      <div class="flex justify-between"><span class="text-gray-600">Montant $:</span><span class="font-bold text-blue-600">$${dollarAmount.toFixed(2)}</span></div>
      <div class="flex justify-between"><span class="text-gray-600">Taux @ ${buyRate}:</span><span class="font-bold text-red-600">${formatCurrency(cost)}</span></div>
      <div class="flex justify-between"><span class="text-gray-600">Prix Vente:</span><span class="font-bold text-green-600">${formatCurrency(price)}</span></div>
      <div class="flex justify-between"><span class="text-gray-600">Marge:</span><span class="font-bold ${marginColor}">${profitPercentage}%</span></div>
    </div>
  `;
    document.getElementById('previewCost').textContent = formatCurrency(cost);
    document.getElementById('previewRevenue').textContent = formatCurrency(price);
    document.getElementById('previewProfit').textContent = formatCurrency(profit);
    const profitPercentElem = document.getElementById('profitPercentage');
    profitPercentElem.textContent = `Marge: ${profitPercentage}%`;
    profitPercentElem.className = 'text-center text-sm font-medium ' + marginColor;
    return;
  }
  if (standardFields) standardFields.classList.add('hidden');
  
  const offer = appState.offers.find(o => o.id == offerId);
  if (!offer) return;
  
  const cost = offer.costPerUnit * buyRate;
  const profit = offer.price - cost;
  const profitPercentage = cost > 0 ? ((profit / cost) * 100).toFixed(2) : 0;
  
  let marginColor = 'text-green-600';
  if (profitPercentage < 10) marginColor = 'text-red-600';
  else if (profitPercentage < 20) marginColor = 'text-yellow-600';
  
  document.getElementById('offerDetails').innerHTML = `
    <div class="space-y-2">
      <div class="flex justify-between"><span class="text-gray-600">Montant $:</span><span class="font-bold text-blue-600">$${offer.costPerUnit.toFixed(2)}</span></div>
      <div class="flex justify-between"><span class="text-gray-600">Taux @ ${buyRate}:</span><span class="font-bold text-red-600">${formatCurrency(cost)}</span></div>
      <div class="flex justify-between"><span class="text-gray-600">Prix Vente:</span><span class="font-bold text-green-600">${formatCurrency(offer.price)}</span></div>
      <div class="flex justify-between"><span class="text-gray-600">Marge:</span><span class="font-bold ${marginColor}">${profitPercentage}%</span></div>
    </div>
  `;
  
  document.getElementById('previewCost').textContent = formatCurrency(cost);
  document.getElementById('previewRevenue').textContent = formatCurrency(offer.price);
  document.getElementById('previewProfit').textContent = formatCurrency(profit);
  document.getElementById('profitPercentage').textContent = `Marge: ${profitPercentage}%`;
  
  const profitPercentElem = document.getElementById('profitPercentage');
  profitPercentElem.className = 'text-center text-sm font-medium ' + marginColor;
}

function calculatePreview() {
  const offerId = document.getElementById('offerSelect').value;
  if (offerId) {
    selectOfferInTransaction();
  }
}

function resetCalculator() {
  document.getElementById('buyRate').value = appState.settings.defaultBuyRate;
  document.getElementById('clientSelect').value = '';
  document.getElementById('clientSearch').value = '';
  const offerSelect = document.getElementById('offerSelect');
  if (offerSelect) offerSelect.value = 'standard';
  document.getElementById('clientDropdown').classList.add('hidden');
  document.getElementById('offerDetails').textContent = 'S√©lectionnez une offre';
  const standardFields = document.getElementById('standardFields');
  if (standardFields) standardFields.classList.remove('hidden');
  const standardDollarInput = document.getElementById('standardDollarAmount');
  const standardPriceInput = document.getElementById('standardPriceDzd');
  const standardDurationInput = document.getElementById('standardDuration');
  if (standardDollarInput) standardDollarInput.value = '';
  if (standardPriceInput) standardPriceInput.value = '';
  if (standardDurationInput) standardDurationInput.value = '';
  const paidCheckbox = document.getElementById('transactionPaid');
  if (paidCheckbox) paidCheckbox.checked = true;
  calculatePreview();
  showToast('Calculatrice r√©initialis√©e', 'info');
}

function addTransaction() {
  const buyRate = parseFloat(document.getElementById('buyRate').value);
  const clientId = document.getElementById('clientSelect').value;
  const offerId = document.getElementById('offerSelect').value;
  
  if (!clientId) {
    showToast('Veuillez s√©lectionner un client', 'error');
    return;
  }
  
  const client = appState.clients.find(c => c.id == clientId);
  let dollarAmount;
  let totalPrice;
  let offerName;
  let duration = '';
  const isPaid = document.getElementById('transactionPaid')?.checked;
  if (offerId === 'standard') {
    const standardDollarInput = document.getElementById('standardDollarAmount');
    const standardPriceInput = document.getElementById('standardPriceDzd');
    const standardDurationInput = document.getElementById('standardDuration');
    const standardDollar = parseFloat(standardDollarInput && standardDollarInput.value);
    const standardPrice = parseFloat(standardPriceInput && standardPriceInput.value);
    if (!standardDollar || !standardPrice) {
      showToast('Veuillez saisir le montant en $ et le prix en DZD', 'error');
      return;
    }
    if (standardDollar <= 0 || standardPrice <= 0) {
      showToast('Les montants doivent √™tre sup√©rieurs √† 0', 'error');
      return;
    }
    dollarAmount = standardDollar;
    totalPrice = standardPrice;
    offerName = 'Standard';
    duration = standardDurationInput && standardDurationInput.value ? standardDurationInput.value.trim() : '';
  } else {
    if (!offerId) {
      showToast('Veuillez s√©lectionner une offre', 'error');
      return;
    }
    const offer = appState.offers.find(o => o.id == offerId);
    if (!offer) {
      showToast('Offre invalide', 'error');
      return;
    }
    dollarAmount = offer.costPerUnit;
    totalPrice = offer.price;
    offerName = offer.name;
    duration = offer.duration || '';
  }
  const cost = dollarAmount * buyRate;
  const profit = totalPrice - cost;
  const sellRate = dollarAmount > 0 ? totalPrice / dollarAmount : 0;
  
  const transaction = {
    id: Date.now(),
    date: new Date().toISOString(),
    clientId: clientId,
    clientName: client ? client.name : 'Inconnu',
    offerName: offerName,
    dollarAmount: dollarAmount,
    buyRate: buyRate,
    sellRate: sellRate,
    totalDzd: totalPrice,
    profit: profit,
    status: isPaid ? 'completed' : 'pending',
    duration: duration
  };
  appState.transactions.unshift(transaction);
  saveToLocalStorage();
  updateDashboard();
  renderTables();
  
  document.getElementById('clientSearch').value = '';
  document.getElementById('clientSelect').value = '';
  const offerSelectElem = document.getElementById('offerSelect');
  if (offerSelectElem) offerSelectElem.value = 'standard';
  document.getElementById('offerDetails').textContent = 'S√©lectionnez une offre';
  const standardFields = document.getElementById('standardFields');
  if (standardFields) standardFields.classList.remove('hidden');
  const standardDollarInput = document.getElementById('standardDollarAmount');
  const standardPriceInput = document.getElementById('standardPriceDzd');
  const standardDurationInput = document.getElementById('standardDuration');
  if (standardDollarInput) standardDollarInput.value = '';
  if (standardPriceInput) standardPriceInput.value = '';
  if (standardDurationInput) standardDurationInput.value = '';
  calculatePreview();
  
  const clientName = client ? client.name : 'Inconnu';
  showToast(`Transaction "${offerName}" de $${dollarAmount} pour ${clientName} enregistr√©e!`, 'success');
  showTab('dashboard');
}

function addClient() {
  const name = document.getElementById('newClientName').value.trim();
  const contact = document.getElementById('newClientContact').value.trim();
  const notes = document.getElementById('newClientNotes').value.trim();
  if (!name) {
    showToast('Le nom du client est requis', 'error');
    return;
  }
  const client = {
    id: Date.now(),
    name: name,
    contact: contact,
    notes: notes,
    totalSpent: 0,
    joinDate: new Date().toISOString(),
    lastActivity: new Date().toISOString()
  };
  appState.clients.push(client);
  saveToLocalStorage();
  closeModal('clientModal');
  renderTables();
  populatePaymentClientSelect();
  document.getElementById('newClientName').value = '';
  document.getElementById('newClientContact').value = '';
  document.getElementById('newClientNotes').value = '';
  showToast(`Client "${name}" ajout√© avec succ√®s`, 'success');
}

function addOffer() {
  const name = document.getElementById('newOfferName').value.trim();
  const desc = document.getElementById('newOfferDesc').value.trim();
  const price = parseFloat(document.getElementById('newOfferPrice').value);
  const costPerUnit = parseFloat(document.getElementById('newOfferCostPerUnit').value);
  
  console.log('DEBUG addOffer:', { name, desc, price, costPerUnit });
  
  if (!name || isNaN(price) || isNaN(costPerUnit)) {
    showToast('Nom, prix de vente et montant √† d√©penser sont requis et doivent √™tre des nombres', 'error');
    return;
  }
  if (price <= 0 || costPerUnit <= 0) {
    showToast('Les montants doivent √™tre sup√©rieurs √† 0', 'error');
    return;
  }
  const offer = {
    id: Date.now(),
    name: name,
    description: desc,
    price: price,
    costPerUnit: costPerUnit,
    duration: document.getElementById('newOfferDuration').value.trim(),
    createdAt: new Date().toISOString(),
    isActive: true
  };
  appState.offers.push(offer);
  console.log('Offre ajout√©e:', offer);
  console.log('Total offres:', appState.offers.length);
  saveToLocalStorage();
  closeModal('offerModal');
  renderTables();
  populateOfferSelect();
  document.getElementById('newOfferName').value = '';
  document.getElementById('newOfferDesc').value = '';
  document.getElementById('newOfferPrice').value = '';
  document.getElementById('newOfferCostPerUnit').value = '';
  document.getElementById('newOfferDuration').value = '';
  showToast(`Offre "${name}" cr√©√©e avec succ√®s`, 'success');
}

function addPayment() {
  const clientId = document.getElementById('paymentClientSelect').value;
  const amount = parseFloat(document.getElementById('paymentAmount').value);
  const method = document.getElementById('paymentMethod').value;
  const status = document.getElementById('paymentStatus').value;
  const note = document.getElementById('paymentNote').value.trim();
  if (!clientId || !amount) {
    showToast('Client et montant sont requis', 'error');
    return;
  }
  if (amount <= 0) {
    showToast('Le montant doit √™tre sup√©rieur √† 0', 'error');
    return;
  }
  const client = appState.clients.find(c => c.id == clientId);
  const payment = {
    id: Date.now(),
    date: new Date().toISOString(),
    clientId: clientId,
    clientName: client ? client.name : 'Inconnu',
    amount: amount,
    method: method,
    status: status,
    note: note
  };
  appState.payments.push(payment);
  saveToLocalStorage();
  closeModal('paymentModal');
  renderTables();
  document.getElementById('paymentAmount').value = '';
  document.getElementById('paymentNote').value = '';
  showToast(`Paiement de ${formatCurrency(amount)} enregistr√©`, 'success');
}

function addUsdPurchase() {
  const amount = parseFloat(document.getElementById('usdAmount').value);
  const rate = parseFloat(document.getElementById('usdRate').value);
  const source = document.getElementById('usdSource').value.trim();
  if (!amount || !rate) {
    showToast('Montant et taux sont requis', 'error');
    return;
  }
  if (amount <= 0 || rate <= 0) {
    showToast('Montant et taux doivent √™tre sup√©rieurs √† 0', 'error');
    return;
  }
  const purchase = {
    id: Date.now(),
    date: new Date().toISOString(),
    amount: amount,
    rate: rate,
    totalDzd: amount * rate,
    source: source
  };
  appState.usdPurchases.push(purchase);
  saveToLocalStorage();
  closeModal('usdPurchaseModal');
  renderTables();
  document.getElementById('usdAmount').value = '';
  document.getElementById('usdSource').value = '';
  showToast(`Achat de $${amount} enregistr√©`, 'success');
}

function populatePaymentClientSelect() {
  const paymentSelect = document.getElementById('paymentClientSelect');
  if (paymentSelect) {
    paymentSelect.innerHTML = '<option value="">Choisir un client...</option>';
    appState.clients.forEach(client => {
      const option = document.createElement('option');
      option.value = client.id;
      option.textContent = `${client.name}${client.contact ? ` (${client.contact})` : ''}`;
      paymentSelect.appendChild(option);
    });
  }
}

function filterClients() {
  const searchInput = document.getElementById('clientSearch');
  const dropdown = document.getElementById('clientDropdown');
  const searchTerm = searchInput.value.toLowerCase().trim();
  
  if (!searchTerm) {
    dropdown.classList.add('hidden');
    document.getElementById('clientSelect').value = '';
    return;
  }
  
  const filtered = appState.clients.filter(client => 
    client.name.toLowerCase().includes(searchTerm) || 
    (client.contact && client.contact.toLowerCase().includes(searchTerm))
  );
  
  dropdown.innerHTML = '';
  
  if (filtered.length === 0) {
    dropdown.innerHTML = '<div class="p-4 text-gray-500 text-center">Aucun client trouv√©</div>';
    dropdown.classList.remove('hidden');
    return;
  }
  
  filtered.forEach(client => {
    const item = document.createElement('div');
    item.className = 'p-4 border-b border-gray-100 hover:bg-blue-50 cursor-pointer transition-colors flex justify-between items-start';
    item.innerHTML = `<div><div class="font-bold text-gray-800">${client.name}</div><div class="text-xs text-gray-500">${client.contact || 'Pas de contact'}</div></div>`;
    item.onclick = () => selectClient(client.id, client.name);
    dropdown.appendChild(item);
  });
  
  dropdown.classList.remove('hidden');
}

function selectClient(clientId, clientName) {
  document.getElementById('clientSelect').value = clientId;
  document.getElementById('clientSearch').value = clientName;
  document.getElementById('clientDropdown').classList.add('hidden');
  calculatePreview();
}

function populateOfferSelect() {
  const select = document.getElementById('offerSelect');
  if (!select) return;
  select.innerHTML = '<option value="standard">Standard (manuel)</option>';
  appState.offers.forEach(offer => {
    const option = document.createElement('option');
    option.value = offer.id;
    option.textContent = `${offer.name} - ${formatCurrency(offer.price)}`;
    select.appendChild(option);
  });
}

function renderTables() {
  renderClientsTable();
  renderTransactionsTable();
  renderOffersGrid();
  renderPaymentsTable();
  renderUsdPurchasesTable();
  updateRecentActivity();
}

function renderClientsTable() {
  const tbody = document.getElementById('clientsTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (appState.clients.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500"><i class="fas fa-users text-4xl mb-3 text-gray-300"></i><p class="text-lg">Aucun client enregistr√©</p><p class="text-sm mt-2">Commencez par ajouter votre premier client</p></td></tr>`;
    return;
  }
  appState.clients.forEach(client => {
    const clientTransactions = appState.transactions.filter(t => t.clientId == client.id);
    const totalSpent = clientTransactions.reduce((sum, t) => sum + t.totalDzd, 0);
    const clientPayments = appState.payments.filter(p => p.clientId == client.id);
    const paidTotal = clientPayments.reduce((sum, p) => sum + p.amount, 0);
    const unpaid = totalSpent - paidTotal;
    const transactionCount = clientTransactions.length;
    const joinDate = new Date(client.joinDate).toLocaleDateString('fr-FR');
    const lastActivity = client.lastActivity ? new Date(client.lastActivity).toLocaleDateString('fr-FR') : 'Jamais';
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 transition-colors';
    row.innerHTML = `<td class="p-4"><div class="font-bold">${client.name}</div><div class="text-sm text-gray-500">Inscrit le ${joinDate}</div></td><td class="p-4"><div>${client.contact || '-'}</div><div class="text-xs text-gray-500">Derni√®re: ${lastActivity}</div></td><td class="p-4 font-bold text-green-600">${formatCurrency(totalSpent)}</td><td class="p-4 font-bold ${unpaid > 0 ? 'text-red-600' : 'text-green-600'}">${formatCurrency(unpaid > 0 ? unpaid : 0)}</td><td class="p-4"><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${transactionCount} transaction${transactionCount > 1 ? 's' : ''}</span></td><td class="p-4"><button onclick="deleteClient(${client.id})" class="text-red-600 hover:text-red-800" title="Supprimer"><i class="fas fa-trash"></i></button></td>`;
    tbody.appendChild(row);
  });
}

function renderTransactionsTable() {
  const tbody = document.getElementById('transactionsTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (appState.transactions.length === 0) {
    tbody.innerHTML = `<tr><td colspan="9" class="p-8 text-center text-gray-500"><i class="fas fa-exchange-alt text-4xl mb-3 text-gray-300"></i><p class="text-lg">Aucune transaction enregistr√©e</p><p class="text-sm mt-2">Utilisez le calculateur pour cr√©er votre premi√®re transaction</p></td></tr>`;
    return;
  }
  const transactions = filterTransactions();
  transactions.forEach(trans => {
    const date = new Date(trans.date).toLocaleDateString('fr-FR');
    const time = new Date(trans.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 transition-colors text-sm';
    row.innerHTML = `<td class="p-4"><div class="font-medium">${date}</div><div class="text-xs text-gray-500">${time}</div></td><td class="p-4">${trans.clientName}</td><td class="p-4"><span class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${trans.offerName}</span></td><td class="p-4 font-bold">$${trans.dollarAmount.toFixed(2)}</td><td class="p-4">${trans.sellRate} DZD</td><td class="p-4 font-bold">${formatCurrency(trans.totalDzd)}</td><td class="p-4"><span class="profit-badge font-bold px-2.5 py-0.5 rounded-full">+${formatCurrency(trans.profit)}</span></td><td class="p-4 text-gray-600">${trans.duration || '-'}</td><td class="p-4"><button onclick="deleteTransaction(${trans.id})" class="text-red-600 hover:text-red-800" title="Supprimer"><i class="fas fa-trash"></i></button></td>`;
    tbody.appendChild(row);
  });
}

function filterTransactions() {
  const searchTerm = document.getElementById('transactionSearch')?.value.toLowerCase() || '';
  const filterValue = document.getElementById('transactionFilter')?.value || 'all';
  let filtered = [...appState.transactions];
  if (searchTerm) {
    filtered = filtered.filter(t => t.clientName.toLowerCase().includes(searchTerm) || t.offerName.toLowerCase().includes(searchTerm) || t.dollarAmount.toString().includes(searchTerm));
  }
  const now = new Date();
  switch(filterValue) {
    case 'today':
      const today = new Date().toDateString();
      filtered = filtered.filter(t => new Date(t.date).toDateString() === today);
      break;
    case 'week':
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      filtered = filtered.filter(t => new Date(t.date) >= oneWeekAgo);
      break;
    case 'month':
      const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
      filtered = filtered.filter(t => new Date(t.date) >= oneMonthAgo);
      break;
  }
  return filtered;
}

function renderOffersGrid() {
  const grid = document.getElementById('offersGrid');
  if (!grid) return;
  grid.innerHTML = '';
  if (appState.offers.length === 0) {
    grid.innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-gift text-5xl mb-4 text-gray-300"></i><p class="text-lg text-gray-500">Aucune offre cr√©√©e</p><p class="text-sm text-gray-400 mt-2">Cr√©ez votre premi√®re offre pour commencer</p></div>`;
    return;
  }
  appState.offers.forEach(offer => {
    const usageCount = appState.transactions.filter(t => t.offerName === offer.name).length;
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 p-6 rounded-2xl hover:border-purple-300 transition-all card-hover';
    
    // Calcul de la marge pour chaque offre
    const buyRate = appState.settings.defaultBuyRate;
    const offerPrice = offer.price;
    const offerCostUSD = offer.costPerUnit;
    const costDzd = offerCostUSD * buyRate;
    const marginDzd = offerPrice - costDzd;
    const marginPercentage = costDzd > 0 ? ((marginDzd / costDzd) * 100).toFixed(2) : 0;
    
    let marginColor = 'text-green-600';
    if (marginPercentage < 10) marginColor = 'text-red-600';
    else if (marginPercentage < 20) marginColor = 'text-yellow-600';
    
    card.innerHTML = `<div class="flex justify-between items-start mb-2"><div><h3 class="text-xl font-bold text-gray-800">${offer.name}</h3><p class="text-xs text-gray-500 mt-1"><i class="fas fa-clock mr-1"></i>${offer.duration || 'Non sp√©cifi√©e'}</p></div><span class="bg-purple-100 text-purple-800 text-xs font-semibold px-3 py-1 rounded-full">${usageCount} vente${usageCount > 1 ? 's' : ''}</span></div><p class="text-gray-600 mb-4 min-h-[50px] text-sm">${offer.description || 'Pas de description'}</p><div class="grid grid-cols-2 gap-3 mb-4 text-sm border-t border-b border-gray-100 py-3"><div><span class="text-gray-600 text-xs block">Montant ($):</span><span class="font-bold text-blue-600">$${offerCostUSD.toFixed(2)}</span></div><div><span class="text-gray-600 text-xs block">Prix Vente (DZD):</span><span class="font-bold text-purple-600">${formatCurrency(offerPrice)}</span></div><div><span class="text-gray-600 text-xs block">Co√ªt @ ${buyRate}:</span><span class="font-bold text-red-600">${formatCurrency(costDzd)}</span></div><div><span class="text-gray-600 text-xs block">Marge:</span><span class="font-bold ${marginColor}">${marginPercentage}%</span></div></div><div class="flex justify-between items-center"><div><p class="text-xs text-gray-500">B√©n√©fice estim√©</p><span class="text-lg font-black text-green-600">${formatCurrency(marginDzd)}</span></div><button onclick="deleteOffer(${offer.id})" class="text-red-600 hover:text-red-800" title="Supprimer"><i class="fas fa-trash"></i></button></div>`;
    grid.appendChild(card);
  });
}

function renderPaymentsTable() {
  const tbody = document.getElementById('paymentsTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (appState.payments.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500"><i class="fas fa-credit-card text-4xl mb-3 text-gray-300"></i><p class="text-lg">Aucun paiement enregistr√©</p><p class="text-sm mt-2">Enregistrez votre premier paiement</p></td></tr>`;
    return;
  }
  appState.payments.forEach(payment => {
    const date = new Date(payment.date).toLocaleDateString('fr-FR');
    const time = new Date(payment.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
    let statusColor = 'bg-gray-100 text-gray-800';
    let statusText = 'Inconnu';
    switch(payment.status) {
      case 'completed': statusColor = 'bg-green-100 text-green-800'; statusText = 'Compl√©t√©'; break;
      case 'pending': statusColor = 'bg-yellow-100 text-yellow-800'; statusText = 'En attente'; break;
      case 'partial': statusColor = 'bg-blue-100 text-blue-800'; statusText = 'Partiel'; break;
    }
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 transition-colors text-sm';
    row.innerHTML = `<td class="p-4"><div class="font-medium">${date}</div><div class="text-xs text-gray-500">${time}</div></td><td class="p-4 font-medium">${payment.clientName}</td><td class="p-4 font-bold text-green-600">${formatCurrency(payment.amount)}</td><td class="p-4"><span class="bg-orange-100 text-orange-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${payment.method}</span></td><td class="p-4"><span class="${statusColor} text-xs font-semibold px-2.5 py-0.5 rounded-full">${statusText}</span></td><td class="p-4 text-gray-600">${payment.note || '-'}</td>`;
    tbody.appendChild(row);
  });
}

function renderUsdPurchasesTable() {
  const tbody = document.getElementById('usdPurchasesTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (appState.usdPurchases.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500"><i class="fas fa-dollar-sign text-4xl mb-3 text-gray-300"></i><p class="text-lg">Aucun achat USD enregistr√©</p><p class="text-sm mt-2">Enregistrez votre premier achat de dollars</p></td></tr>`;
    return;
  }
  appState.usdPurchases.forEach(purchase => {
    const date = new Date(purchase.date).toLocaleDateString('fr-FR');
    const time = new Date(purchase.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 transition-colors text-sm';
    row.innerHTML = `<td class="p-4"><div class="font-medium">${date}</div><div class="text-xs text-gray-500">${time}</div></td><td class="p-4 font-bold">$${purchase.amount.toFixed(2)}</td><td class="p-4">${purchase.rate} DZD</td><td class="p-4 font-bold text-red-600">${formatCurrency(purchase.totalDzd)}</td><td class="p-4 text-gray-700">${purchase.source || '-'}</td><td class="p-4"><button onclick="deleteUsdPurchase(${purchase.id})" class="text-red-600 hover:text-red-800" title="Supprimer"><i class="fas fa-trash"></i></button></td>`;
    tbody.appendChild(row);
  });
}

function refreshAutoSaveTimer() {
  const s = appState.settings || {};
  const enabled = !!s.autoSaveEnabled;
  const minutes = s.autoSaveIntervalMinutes || 60;
  if (autoSaveTimer) clearTimeout(autoSaveTimer);
  if (enabled && minutes > 0) {
    autoSaveTimer = setTimeout(function() {
      saveToLocalStorage();
    }, minutes * 60 * 1000);
  }
}

function saveToLocalStorage() {
  if (appState.settings && appState.settings.storageMode === 'server' && appState.settings.backendUrl) {
    fetch(appState.settings.backendUrl + '/data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(appState)
    }).then(() => {
      refreshAutoSaveTimer();
    }).catch(() => {
      localStorage.setItem('sponsoringManagerData', JSON.stringify(appState));
      refreshAutoSaveTimer();
    });
  } else if (appState.settings && appState.settings.storageMode === 'cloud' && appState.settings.cloudProvider === 'firebase' && appState.settings.firebaseConfig && appState.settings.firebaseConfig.apiKey) {
    if (!window.firebase.apps.length) { firebase.initializeApp(appState.settings.firebaseConfig); }
    const db = firebase.firestore();
    db.collection('appState').doc('main').set(appState).then(() => {
      refreshAutoSaveTimer();
    }).catch(() => {
      localStorage.setItem('sponsoringManagerData', JSON.stringify(appState));
      refreshAutoSaveTimer();
    });
  } else {
    localStorage.setItem('sponsoringManagerData', JSON.stringify(appState));
    refreshAutoSaveTimer();
  }
}

async function loadFromLocalStorage() {
  const saved = localStorage.getItem('sponsoringManagerData');
  if (appState.settings && appState.settings.storageMode === 'server' && appState.settings.backendUrl) {
    try {
      const res = await fetch(appState.settings.backendUrl + '/data');
      if (res.ok) {
        const data = await res.json();
        if (data && Object.keys(data).length) {
          appState = data;
          return;
        }
      }
    } catch (e) {}
  } else if (appState.settings && appState.settings.storageMode === 'cloud' && appState.settings.cloudProvider === 'firebase' && appState.settings.firebaseConfig && appState.settings.firebaseConfig.apiKey) {
    try {
      if (!window.firebase.apps.length) { firebase.initializeApp(appState.settings.firebaseConfig); }
      const db = firebase.firestore();
      const snap = await db.collection('appState').doc('main').get();
      if (snap.exists) {
        const data = snap.data();
        if (data && Object.keys(data).length) {
          appState = data;
          return;
        }
      }
    } catch (e) {}
  }
  if (saved) {
    appState = JSON.parse(saved);
  } else {
    const now = new Date().toISOString();
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
    appState = {
      clients: [
        { id: 1, name: "Mohamed Ali", contact: "0555-123456", notes: "Client r√©gulier", totalSpent: 0, joinDate: weekAgo, lastActivity: now },
        { id: 2, name: "Fatima Zahra", contact: "Facebook: Fati.z", notes: "Pr√©f√®re les paiements en cash", totalSpent: 0, joinDate: now, lastActivity: now }
      ],
      transactions: [
        { id: 1, date: now, clientId: 1, clientName: "Mohamed Ali", offerName: "Pack Pro", dollarAmount: 10, buyRate: 255, sellRate: 357, totalDzd: 3570, profit: 1020, status: 'completed' }
      ],
      offers: [
        { id: 1, name: "Pack Starter", description: "Parfait pour d√©butants - 5$ minimum", price: 50000, costPerUnit: 5, createdAt: weekAgo, isActive: true },
        { id: 2, name: "Pack Pro", description: "Pour investisseurs s√©rieux - 10$ minimum", price: 150000, costPerUnit: 10, createdAt: weekAgo, isActive: true }
      ],
      payments: [
        { id: 1, date: now, clientId: 1, clientName: "Mohamed Ali", amount: 3570, method: "Cash", status: "completed", note: "Paiement complet" }
      ],
      usdPurchases: [
        { id: 1, date: weekAgo, amount: 100, rate: 250, totalDzd: 25000, source: "Binance P2P" }
      ],
      currentTab: 'dashboard',
      settings: {
        defaultBuyRate: 255,
        defaultSellRate: 357,
        currency: 'DZD',
        storageMode: 'local',
        backendUrl: '',
        autoSaveEnabled: true,
        autoSaveIntervalMinutes: 60
      }
    };
  }
}

function updateDashboard() {
  const today = new Date().toDateString();
  const todayTransactions = appState.transactions.filter(t => new Date(t.date).toDateString() === today);
  const todayProfit = todayTransactions.reduce((sum, t) => sum + t.profit, 0);
  const oneWeekAgo = new Date();
  oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  const weekTransactions = appState.transactions.filter(t => new Date(t.date) >= oneWeekAgo);
  const weekProfit = weekTransactions.reduce((sum, t) => sum + t.profit, 0);
  const totalProfit = appState.transactions.reduce((sum, t) => sum + t.profit, 0);
  document.getElementById('todayProfit').textContent = formatCurrency(todayProfit);
  document.getElementById('weekProfit').textContent = formatCurrency(weekProfit);
  document.getElementById('totalProfit').textContent = formatCurrency(totalProfit);
  document.getElementById('totalClients').textContent = appState.clients.length;
  document.getElementById('weekTransactions').textContent = `${weekTransactions.length} transactions`;
  document.getElementById('totalTransactions').textContent = `${appState.transactions.length} transactions`;
}

function updateRecentActivity() {
  const container = document.getElementById('recentTransactions');
  if (!container) return;
  container.innerHTML = '';
  const activityCount = document.getElementById('activityCount');
  const recent = appState.transactions.slice(0, 10);
  if (recent.length === 0) {
    container.innerHTML = `<div class="text-center py-10"><i class="fas fa-exchange-alt text-4xl mb-3 text-gray-300"></i><p class="text-gray-400 italic">Aucune transaction r√©cente</p><p class="text-sm text-gray-500 mt-2">Les transactions appara√Ætront ici</p></div>`;
    if (activityCount) activityCount.textContent = '0 transactions';
    return;
  }
  if (activityCount) activityCount.textContent = `${recent.length} transaction${recent.length > 1 ? 's' : ''}`;
  recent.forEach(trans => {
    const date = new Date(trans.date).toLocaleDateString('fr-FR');
    const time = new Date(trans.date).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
    const item = document.createElement('div');
    item.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-xl hover:bg-white border border-gray-100 transition-colors';
    item.innerHTML = `<div><p class="font-bold">${trans.clientName}</p><p class="text-sm text-gray-500">${trans.dollarAmount}$ le ${date} √† ${time}</p></div><div class="text-right"><p class="font-bold">$${trans.dollarAmount.toFixed(2)}</p><p class="text-sm font-bold text-green-600">+${formatCurrency(trans.profit)}</p></div>`;
    container.appendChild(item);
  });
}

function updateClientsSummary() {
  const totalSpent = appState.clients.reduce((sum, client) => {
    const clientTransactions = appState.transactions.filter(t => t.clientId == client.id);
    return sum + clientTransactions.reduce((sumT, t) => sumT + t.totalDzd, 0);
  }, 0);
  document.getElementById('clientsSummary').textContent = `${appState.clients.length} client${appState.clients.length > 1 ? 's' : ''}`;
  document.getElementById('clientsTotalSpent').textContent = `Total d√©pens√©: ${formatCurrency(totalSpent)}`;
}

function updateTransactionsSummary() {
  const totalProfit = appState.transactions.reduce((sum, t) => sum + t.profit, 0);
  document.getElementById('transactionsSummary').textContent = `${appState.transactions.length} transaction${appState.transactions.length > 1 ? 's' : ''}`;
  document.getElementById('transactionsTotalProfit').textContent = `Profit total: ${formatCurrency(totalProfit)}`;
}

function deleteClient(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce client ? Cette action est irr√©versible.')) { return; }
  const client = appState.clients.find(c => c.id === id);
  appState.clients = appState.clients.filter(c => c.id !== id);
  appState.transactions = appState.transactions.filter(t => t.clientId !== id);
  appState.payments = appState.payments.filter(p => p.clientId !== id);
  saveToLocalStorage();
  renderTables();
  updateDashboard();
  showToast(`Client "${client.name}" supprim√©`, 'success');
}

function deleteTransaction(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette transaction ?')) { return; }
  appState.transactions = appState.transactions.filter(t => t.id !== id);
  saveToLocalStorage();
  renderTables();
  updateDashboard();
  showToast('Transaction supprim√©e', 'success');
}

function deleteOffer(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette offre ?')) { return; }
  const offer = appState.offers.find(o => o.id === id);
  appState.offers = appState.offers.filter(o => o.id !== id);
  saveToLocalStorage();
  renderTables();
  showToast(`Offre "${offer.name}" supprim√©e`, 'success');
}

function deleteUsdPurchase(id) {
  if (!confirm('√ätes-vous s√ªr de vouloir supprimer cet achat USD ?')) { return; }
  appState.usdPurchases = appState.usdPurchases.filter(p => p.id !== id);
  saveToLocalStorage();
  renderTables();
  showToast('Achat USD supprim√©', 'success');
}

function openModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  modal.style.animation = 'modalFadeIn 0.3s ease';
  document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  document.body.style.overflow = 'auto';
}

function closeAllModals() {
  document.querySelectorAll('[id$="Modal"]').forEach(modal => {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  });
  document.body.style.overflow = 'auto';
}

function exportPDF() { showToast('Export PDF en d√©veloppement', 'info'); }

function backupData() {
  const dataStr = JSON.stringify(appState, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  const exportFileDefaultName = `sponsoring_backup_${new Date().toISOString().split('T')[0]}.json`;
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  showToast('Backup t√©l√©charg√© avec succ√®s!', 'success');
}

function importData() { document.getElementById('fileInput').click(); }

function handleFileLoad(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      appState = imported;
      saveToLocalStorage();
      renderTables();
      updateDashboard();
      populateOfferSelect();
      populatePaymentClientSelect();
      showToast('Donn√©es import√©es avec succ√®s!', 'success');
    } catch (err) {
      showToast('Erreur: fichier JSON invalide', 'error');
    }
  };
  reader.readAsText(file);
  input.value = '';
}

function exportClientsCSV() { showToast('Export CSV en d√©veloppement', 'info'); }
function showStats() { showToast('Tableau de bord avanc√© en d√©veloppement', 'info'); }

function formatCurrency(amount) {
  return new Intl.NumberFormat('fr-DZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount) + ' DZD';
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastIcon = document.getElementById('toastIcon');
  const toastTitle = document.getElementById('toastTitle');
  const toastMessage = document.getElementById('toastMessage');
  if (!toast) return;
  let icon = 'fa-check-circle';
  let iconColor = 'text-green-400';
  let title = 'Succ√®s';
  let bgColor = 'bg-gray-800';
  switch(type) {
    case 'error': icon = 'fa-exclamation-circle'; iconColor = 'text-red-400'; title = 'Erreur'; bgColor = 'bg-red-800'; break;
    case 'warning': icon = 'fa-exclamation-triangle'; iconColor = 'text-yellow-400'; title = 'Attention'; bgColor = 'bg-yellow-800'; break;
    case 'info': icon = 'fa-info-circle'; iconColor = 'text-blue-400'; title = 'Information'; bgColor = 'bg-blue-800'; break;
  }
  toastIcon.className = `fas ${icon} ${iconColor} text-xl`;
  toastTitle.textContent = title;
  toastMessage.textContent = message;
  toast.className = `fixed bottom-4 right-4 ${bgColor} text-white p-4 rounded-xl shadow-2xl z-50 max-w-sm transition-all duration-300`;
  toast.classList.remove('hidden');
  toast.style.opacity = '1';
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => {
      toast.classList.add('hidden');
    }, 300);
  }, 3000);
}

window.showTab = showTab;
window.calculatePreview = calculatePreview;
window.addTransaction = addTransaction;
window.addClient = addClient;
window.addOffer = addOffer;
window.addPayment = addPayment;
window.addUsdPurchase = addUsdPurchase;
window.deleteClient = deleteClient;
window.deleteTransaction = deleteTransaction;
window.deleteOffer = deleteOffer;
window.deleteUsdPurchase = deleteUsdPurchase;
window.openModal = openModal;
window.closeModal = closeModal;
window.exportPDF = exportPDF;
window.backupData = backupData;
window.importData = importData;
window.handleFileLoad = handleFileLoad;
window.exportClientsCSV = exportClientsCSV;
window.showStats = showStats;
window.resetCalculator = resetCalculator;
window.filterTransactions = filterTransactions;
window.filterClients = filterClients;
window.selectClient = selectClient;
window.setupClientSearchListeners = setupClientSearchListeners;
</script>

</body>
</html>
